#include <stdio.h>

#include <hardware/watchdog.h>

#include <shared/apps/apps.h>

static const unsigned char image_Sprite_0001_bits[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7c, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7c,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x7c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x38, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x01,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0xff, 0x00, 0x87, 0x0f, 0x1c,
    0x00, 0xff, 0xc1, 0xe3, 0xe1, 0x07, 0x00, 0x00, 0x00, 0x00, 0xf0, 0xff,
    0x83, 0xef, 0x1f, 0x3e, 0xe0, 0xff, 0xe3, 0xf3, 0xf7, 0x0f, 0x00, 0x00,
    0x00, 0x00, 0xf0, 0xff, 0x87, 0xff, 0x3f, 0x3e, 0xf0, 0xff, 0xe3, 0xfb,
    0xff, 0x1f, 0x00, 0x00, 0x00, 0x00, 0xf0, 0xff, 0x8f, 0xff, 0x3f, 0x3e,
    0xf8, 0xff, 0xe3, 0xff, 0xff, 0x1f, 0x00, 0x00, 0x00, 0x00, 0xf0, 0xff,
    0x8f, 0xff, 0x3f, 0x3e, 0xf8, 0xff, 0xe3, 0xff, 0xff, 0x1f, 0x00, 0x00,
    0x00, 0x00, 0xf0, 0x87, 0x8f, 0x7f, 0x3e, 0x3e, 0xf8, 0xc0, 0xe1, 0xdf,
    0xbf, 0x1f, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x03, 0x9f, 0x3f, 0x3c, 0x3e,
    0xf8, 0x00, 0xe0, 0xcf, 0x0f, 0x1f, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x01,
    0x9f, 0x1f, 0x18, 0x3e, 0xf0, 0x03, 0xe0, 0xc7, 0x07, 0x1f, 0x00, 0x00,
    0x00, 0x00, 0xf0, 0x01, 0x9f, 0x0f, 0x00, 0x3e, 0xf0, 0x0f, 0xe0, 0xc7,
    0x07, 0x1f, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x01, 0x9f, 0x0f, 0x00, 0x3e,
    0xe0, 0x3f, 0xe0, 0xc3, 0x07, 0x1f, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x01,
    0x9f, 0x0f, 0x00, 0x3e, 0x80, 0xff, 0xe0, 0xc3, 0x07, 0x3f, 0x00, 0x00,
    0x00, 0x00, 0xf0, 0x01, 0x9f, 0x0f, 0x00, 0x3e, 0x00, 0xfe, 0xe1, 0x83,
    0x0f, 0x3f, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x01, 0x9f, 0x0f, 0x00, 0x3e,
    0x00, 0xf0, 0xe3, 0x83, 0x0f, 0x3f, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x81,
    0x9f, 0x0f, 0x00, 0x3e, 0x00, 0xe0, 0xe3, 0x83, 0x0f, 0x3f, 0x00, 0x00,
    0x00, 0x00, 0xf0, 0xc1, 0x8f, 0x0f, 0x00, 0x3e, 0x78, 0xf0, 0xe3, 0x83,
    0x0f, 0x3e, 0x00, 0x00, 0x00, 0x00, 0xf0, 0xff, 0x8f, 0x0f, 0x00, 0x3e,
    0xfc, 0xff, 0xe3, 0x83, 0x0f, 0x3e, 0x00, 0x00, 0x00, 0x00, 0xf0, 0xff,
    0x87, 0x0f, 0x00, 0x3e, 0xfc, 0xff, 0xe1, 0x83, 0x0f, 0x3e, 0x00, 0x00,
    0x00, 0x00, 0xf0, 0xff, 0x83, 0x0f, 0x00, 0x3e, 0xfc, 0xff, 0xe1, 0x83,
    0x0f, 0x3e, 0x00, 0x00, 0x00, 0x00, 0xf0, 0xff, 0x81, 0x0f, 0x00, 0x3e,
    0xf8, 0x7f, 0xe0, 0x83, 0x0f, 0x3e, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x7f,
    0x00, 0x07, 0x00, 0x1c, 0xc0, 0x1f, 0xc0, 0x81, 0x0f, 0x3e, 0x00, 0x00,
    0x00, 0x00, 0xf0, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x07, 0x1c, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x01, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x01,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xf0, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x01, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x01,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xf0, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x01, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00};

static void enter() {
  audio_synth_operator_config_t config = audio_synth_operator_config_default;
  config.env = (audio_synth_env_config_t){
      .a = 0,
      .d = 700,
      .s = q1x31_f(.2f), // sustain level
      .r = 200,
  };
  config.freq_mult = 11;
  config.level = q1x15_f(0.3f);
  audio_synth_operator_set_config(&engine.synth.voices[0].ops[0], config);
  audio_synth_operator_set_config(&engine.synth.voices[1].ops[0], config);

  config = audio_synth_operator_config_default;
  config.env = (audio_synth_env_config_t){
      .a = 0,
      .d = 1200,
      .s = q1x31_f(0.f), // sustain level
      .r = 300,
  };
  config.level = q1x15_f(.5f);
  config.mode = AUDIO_SYNTH_OP_MODE_FREQ_MOD;
  audio_synth_operator_set_config(&engine.synth.voices[0].ops[1], config);
  audio_synth_operator_set_config(&engine.synth.voices[1].ops[1], config);
}

static void frame() {
  static uint8_t i = 0;
  u8g2_t *u8g2 = &engine.display.u8g2;

  u8g2_SetBitmapMode(u8g2, 1);
  u8g2_DrawXBM(u8g2, 0, 0, 128, 64, image_Sprite_0001_bits);
  engine.leds.colors[0].hex = 0x00d9ff;
  engine.leds.colors[1].hex = 0xff7700;

  return;
  u8g2_SetDrawColor(u8g2, 1);

  if (i < 127) {
    u8g2_DrawBox(u8g2, 0, 0, u8g2->width, u8g2->height);
  } else {
    u8g2_SetFont(u8g2, u8g2_font_5x7_tf);
    if (engine.peripheral.plugged_in) {
      u8g2_DrawStr(u8g2, 0, 30, "USB");
    } else {
      u8g2_DrawStr(u8g2, 0, 30, "BAT");
    }
    char battery_str[8];
    snprintf(battery_str, sizeof(battery_str), "%d",
             engine.peripheral.battery_level);
    u8g2_DrawStr(u8g2, 0, 40, battery_str);
  }
  i++;
  leds_set_all(&engine.leds, (color_t){.hex = 0xFFFFFFFF});

  if (engine.buttons.left.pressed) {
    engine.leds.colors[0].r = 0;
  }
  if (engine.buttons.right.pressed) {
    engine.leds.colors[1].r = 0;
  }
  if (engine.buttons.menu.pressed) {
    engine.leds.colors[0].b = 0;
    engine.leds.colors[1].b = 0;
  }

  if (engine.buttons.left.edge) {
    printf("l edge\n");
    if (engine.buttons.left.pressed) {
      audio_synth_enqueue(&engine.synth,
                          &(audio_synth_message_t){
                              .type = AUDIO_SYNTH_MESSAGE_NOTE_ON,
                              .data.note_on =
                                  {
                                      .voice = 0,
                                      .note_number = note("C4"),
                                      .velocity = 100,
                                  },
                          });
    } else {
      audio_synth_enqueue(&engine.synth,
                          &(audio_synth_message_t){
                              .type = AUDIO_SYNTH_MESSAGE_NOTE_OFF,
                              .data.note_off = {.voice = 0},
                          });
    }
  }
  if (engine.buttons.right.edge) {
    if (engine.buttons.right.pressed) {
      audio_synth_enqueue(&engine.synth,
                          &(audio_synth_message_t){
                              .type = AUDIO_SYNTH_MESSAGE_NOTE_ON,
                              .data.note_on =
                                  {
                                      .voice = 1,
                                      .note_number = note("G4"),
                                      .velocity = 100,
                                  },
                          });
    } else {
      audio_synth_enqueue(&engine.synth,
                          &(audio_synth_message_t){
                              .type = AUDIO_SYNTH_MESSAGE_NOTE_OFF,
                              .data.note_off = {.voice = 1},
                          });
    }
  }

  if (engine.buttons.menu.pressed && engine.buttons.left.pressed &&
      engine.buttons.right.pressed) {
    display_set_enabled(&engine.display, false);
    peripheral_set_enabled(&engine.peripheral, false);
    audio_playback_set_enabled(false);
    watchdog_disable();
    while (1) {
      // trap until reset from watchdog or machine
      sleep_ms(1000);
      if (engine_button_read(BUTTON_MENU)) {
        watchdog_enable(0, 0);
        while (1)
          ;
      }
    }
  }
}

engine_app_t app_full_test = {
    .name = "full_test",
    .enter = enter,
    .frame = frame,
};
